<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Agent - Chatbot DZ</title>
    <style>
        /* CSS... (inchang√©) */
        body { font-family: sans-serif; display: grid; place-items: center; min-height: 100vh; background: #f4f4f4; }
        .container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 450px; }
        #dashboard-content { display: none; }
        #login-form { display: block; }
        input { display: block; margin-bottom: 1rem; padding: 0.5rem; width: 300px; }
        button { padding: 0.5rem 1rem; cursor: pointer; }
        .ticket { border: 1px solid #ccc; padding: 1rem; margin-top: 1rem; border-radius: 4px; background: #f9f9f9; }
        .ticket h4 { margin: 0 0 0.5rem 0; color: #007bff; }
        .ticket p { margin: 0; font-style: italic; font-weight: bold;}
        .ticket span { font-size: 0.8rem; color: #555; display: block; margin-top: 0.5rem; }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="login-form">
            <h2>Connexion Agent</h2>
            <input type="email" id="email" placeholder="Email" value="admin@chatbot-dz.com">
            <input type="password" id="password" placeholder="Mot de passe">
            <button id="login-btn">Se connecter</button>
            <p id="login-error" style="color: red;"></p>
        </div>

        <div id="dashboard-content">
            <h2>Tickets Handoff üí¨</h2>
            <p>Connect√© en tant que r√¥le **user**.</p>
            <button id="logout-btn">D√©connexion</button>
            <div id="tickets-list">
                <p>Chargement des tickets...</p>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        
        // URLs Nhost (Les m√™mes, sans le client Nhost)
        const AUTH_URL = 'https://mzstncjahdwecptxgtop.nhost.run/v1/auth';
        const GRAPHQL_URL = 'https://mzstncjahdwecptxgtop.hasura.eu-central-1.nhost.run/v1/graphql';
        const SESSION_KEY = 'nhost_auth_session'; // Cl√© de stockage

        // √âl√©ments du DOM
        const loginForm = document.getElementById('login-form');
        const dashboardContent = document.getElementById('dashboard-content');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const ticketsList = document.getElementById('tickets-list');

        let accessToken = null; // Stocke le jeton pour les requ√™tes GraphQL

        // --- Logique de Stockage et d'Authentification ---

        function getStoredSession() {
            try {
                const session = localStorage.getItem(SESSION_KEY);
                if (session) return JSON.parse(session);
            } catch (e) {
                console.error("Erreur de lecture de session:", e);
            }
            return null;
        }

        function setSession(sessionData) {
            if (sessionData && sessionData.accessToken) {
                localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
                accessToken = sessionData.accessToken;
                return true;
            }
            return false;
        }

        function clearSession() {
            localStorage.removeItem(SESSION_KEY);
            accessToken = null;
        }

        loginBtn.onclick = async () => {
            loginError.textContent = '';
            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                // UTILISATION DE FETCH pour la connexion
                const response = await fetch(`${AUTH_URL}/signin/email-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message || data.error);
                }

                if (data.session && data.session.accessToken) {
                    setSession(data.session);
                    showDashboard();
                }

            } catch (error) {
                console.error(error);
                loginError.textContent = "Erreur: V√©rifiez Email/Mot de passe. " + error.message;
            }
        };

        logoutBtn.onclick = () => {
            clearSession();
            showLoginForm();
        };


        // --- Fonctions du Dashboard ---

        function showDashboard() {
            loginForm.style.display = 'none';
            dashboardContent.style.display = 'block';
            fetchTicketsOnce(); // Charger les tickets apr√®s la connexion
        }

        function showLoginForm() {
            loginForm.style.display = 'block';
            dashboardContent.style.display = 'none';
            ticketsList.innerHTML = '';
        }

        async function fetchTicketsOnce() {
            
            const GET_TICKETS_QUERY = `
                query GetOpenTickets { 
                    Chatbot_DZ_Tickets_Handoff {
                        id
                        channel_id
                        last_message
                        status
                    }
                }
            `;
            
            // La requ√™te est d√©sormais AUTHENTIFI√âE par le jeton JWT
            try {
                const response = await fetch(GRAPHQL_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}` // Le JWT est envoy√© ici
                    },
                    body: JSON.stringify({ query: GET_TICKETS_QUERY })
                });

                const result = await response.json();
                
                if (result.errors) {
                    console.error('Erreur GraphQL/Permissions:', result.errors);
                    ticketsList.innerHTML = '<p style="color:red;">‚ùå Erreur GraphQL: Le r√¥le **user** n\'a pas la permission de lire la table. **V√©rifiez Hasura**.</p>';
                    return;
                }

                if (result.data && result.data.Chatbot_DZ_Tickets_Handoff) {
                    renderTickets(result.data.Chatbot_DZ_Tickets_Handoff);
                } else {
                    // Devrait √™tre impossible si la requ√™te n'a pas d'erreurs
                    ticketsList.innerHTML = '<p style="color:orange;">‚ö†Ô∏è Requ√™te r√©ussie mais donn√©es manquantes. (Bug Hasura/Rendu).</p>';
                }

            } catch (error) {
                console.error('Erreur R√©seau/Serveur:', error);
                ticketsList.innerHTML = '<p style="color:red;">‚ö†Ô∏è Erreur de connexion ou serveur hors ligne.</p>';
            }
        }

        function renderTickets(tickets) {
            ticketsList.innerHTML = ''; 
            if (!tickets || tickets.length === 0) {
                ticketsList.innerHTML = '<p>‚úÖ Aucun ticket trouv√© pour le moment.</p>';
                return; 
            }
            for (const ticket of tickets) {
                const ticketEl = document.createElement('div');
                ticketEl.className = 'ticket';
                const ticketId = ticket.id.substring(0, 15) + '...';
                ticketEl.innerHTML = `
                    <h4>ID Conversation: ${ticketId}</h4>
                    <p>Dernier message: **${ticket.last_message}**</p>
                    <span>Statut: ${ticket.status}</span>
                `;
                ticketsList.appendChild(ticketEl);
            }
        }
        
        // --- V√©rifier au d√©marrage si l'utilisateur est d√©j√† connect√© ---
        const initialSession = getStoredSession();
        if (initialSession) {
            accessToken = initialSession.accessToken;
            showDashboard();
        }
    </script>
</body>
</html>
